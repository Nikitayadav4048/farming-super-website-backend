<!DOCTYPE html>
<html>
<head>
    <title>Simple Login - Farming Website</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 400px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>Farming Website</h1>
    
    <div id="registerForm">
        <h2>Register</h2>
        <form id="register">
            <div class="form-group">
                <input type="text" placeholder="Full Name" required>
            </div>
            <div class="form-group">
                <input type="email" placeholder="Email" required>
            </div>
            <div class="form-group">
                <input type="password" placeholder="Password" required>
            </div>
            <div class="form-group">
                <select required>
                    <option value="">Select Role</option>
                    <option value="admin">Admin</option>
                    <option value="pilot">Pilot</option>
                    <option value="farmer">Farmer</option>
                    <option value="retail">Retail</option>
                </select>
            </div>
            <button type="submit">Register</button>
        </form>
    </div>
    
    <hr style="margin: 30px 0;">
    
    <div id="loginForm">
        <h2>Login</h2>
        
        <!-- Password Login -->
        <div id="passwordLogin">
            <form id="login">
                <div class="form-group">
                    <input type="email" id="loginEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" placeholder="Password" required>
                </div>
                <button type="submit">Login with Password</button>
            </form>
            <p style="text-align: center; margin: 10px 0;">OR</p>
            <button onclick="showOTPLogin()" style="background: #28a745;">Login with Email OTP</button>
            <p style="text-align: center; margin: 10px 0;">
                <a href="#" onclick="showForgotPassword()" style="color: #007bff; text-decoration: none;">Forgot Password?</a>
            </p>
        </div>
        
        <!-- OTP Login -->
        <div id="otpLogin" style="display: none;">
            <div class="form-group">
                <input type="email" id="otpEmail" placeholder="Enter your email">
            </div>
            <button onclick="sendOTP()" id="sendOTPBtn">Send OTP</button>
            
            <div id="otpVerification" style="display: none; margin-top: 15px;">
                <div class="form-group">
                    <input type="text" id="otpCode" placeholder="Enter OTP" maxlength="6">
                </div>
                <div class="form-group">
                    <input type="text" id="userName" placeholder="Your Name (for new users)">
                </div>
                <div class="form-group">
                    <select id="userRole">
                        <option value="farmer">Farmer</option>
                        <option value="pilot">Pilot</option>
                        <option value="retail">Retail</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button onclick="verifyOTP()">Verify & Login</button>
            </div>
            
            <button onclick="showPasswordLogin()" style="background: #6c757d; margin-top: 10px;">Back to Password Login</button>
        </div>
        
        <!-- Forgot Password -->
        <div id="forgotPassword" style="display: none;">
            <h3>Reset Password</h3>
            <div class="form-group">
                <input type="email" id="resetEmail" placeholder="Enter your email">
            </div>
            <button onclick="sendResetOTP()" id="sendResetBtn">Send Reset OTP</button>
            
            <div id="resetVerification" style="display: none; margin-top: 15px;">
                <div class="form-group">
                    <input type="text" id="resetOTP" placeholder="Enter OTP" maxlength="6">
                </div>
                <div class="form-group">
                    <input type="password" id="newPassword" placeholder="New Password (min 6 chars)">
                </div>
                <button onclick="resetPassword()">Reset Password</button>
            </div>
            
            <button onclick="showPasswordLogin()" style="background: #6c757d; margin-top: 10px;">Back to Login</button>
        </div>
    </div>
    
    <div id="result"></div>
    
    <script>
        // Register
        document.getElementById('register').onsubmit = function(e) {
            e.preventDefault();
            const name = e.target[0].value;
            const email = e.target[1].value;
            const password = e.target[2].value;
            const role = e.target[3].value;
            
            fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, password, role })
            })
            .then(res => res.json())
            .then(data => {
                if (data.token) {
                    document.getElementById('result').innerHTML = 
                        `<div class="result success">
                            <h3>✅ Registration Success!</h3>
                            <p>Name: ${data.user.name}</p>
                            <p>Email: ${data.user.email}</p>
                            <p>Role: ${data.user.role}</p>
                        </div>`;
                } else {
                    throw new Error(data.error);
                }
            })
            .catch(err => {
                document.getElementById('result').innerHTML = 
                    `<div class="result error">
                        <h3>❌ Registration Failed</h3>
                        <p>${err.message}</p>
                    </div>`;
            });
        };
        
        // Password Login
        document.getElementById('login').onsubmit = function(e) {
            e.preventDefault();
            const email = e.target[0].value;
            const password = e.target[1].value;
            
            fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            })
            .then(res => res.json())
            .then(data => {
                if (data.token) {
                    showLoginSuccess(data);
                } else {
                    throw new Error(data.error);
                }
            })
            .catch(err => {
                showError('Login Failed', err.message);
            });
        };
        
        // OTP Login Functions
        function showOTPLogin() {
            document.getElementById('passwordLogin').style.display = 'none';
            document.getElementById('otpLogin').style.display = 'block';
        }
        
        function showPasswordLogin() {
            document.getElementById('passwordLogin').style.display = 'block';
            document.getElementById('otpLogin').style.display = 'none';
            document.getElementById('forgotPassword').style.display = 'none';
            document.getElementById('otpVerification').style.display = 'none';
            document.getElementById('resetVerification').style.display = 'none';
        }
        
        function showForgotPassword() {
            document.getElementById('passwordLogin').style.display = 'none';
            document.getElementById('otpLogin').style.display = 'none';
            document.getElementById('forgotPassword').style.display = 'block';
        }
        
        async function sendOTP() {
            const email = document.getElementById('otpEmail').value;
            if (!email) {
                showError('Error', 'Please enter your email');
                return;
            }
            
            document.getElementById('sendOTPBtn').textContent = 'Sending...';
            
            try {
                const response = await fetch('/api/email-otp/send-email-otp', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email})
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('otpVerification').style.display = 'block';
                    document.getElementById('sendOTPBtn').textContent = 'OTP Sent!';
                    showSuccess('OTP Sent', data.message + (data.otp ? ` OTP: ${data.otp}` : ''));
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showError('Failed to send OTP', error.message);
                document.getElementById('sendOTPBtn').textContent = 'Send OTP';
            }
        }
        
        async function verifyOTP() {
            const email = document.getElementById('otpEmail').value;
            const otp = document.getElementById('otpCode').value;
            const name = document.getElementById('userName').value;
            const role = document.getElementById('userRole').value;
            
            if (!otp) {
                showError('Error', 'Please enter OTP');
                return;
            }
            
            try {
                const response = await fetch('/api/email-otp/verify-email-otp', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, otp, name, role})
                });
                const data = await response.json();
                
                if (data.success) {
                    showLoginSuccess(data);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showError('Verification Failed', error.message);
            }
        }
        
        // Helper Functions
        function showLoginSuccess(data) {
            document.getElementById('result').innerHTML = 
                `<div class="result success">
                    <h3>✅ Login Success!</h3>
                    <p>Name: ${data.user.name}</p>
                    <p>Email: ${data.user.email}</p>
                    <p>Role: ${data.user.role}</p>
                    <p>Token: ${data.token.substring(0, 20)}...</p>
                </div>`;
        }
        
        function showError(title, message) {
            document.getElementById('result').innerHTML = 
                `<div class="result error">
                    <h3>❌ ${title}</h3>
                    <p>${message}</p>
                </div>`;
        }
        
        function showSuccess(title, message) {
            document.getElementById('result').innerHTML = 
                `<div class="result success">
                    <h3>✅ ${title}</h3>
                    <p>${message}</p>
                </div>`;
        }
        
        // Forgot Password Functions
        async function sendResetOTP() {
            const email = document.getElementById('resetEmail').value;
            if (!email) {
                showError('Error', 'Please enter your email');
                return;
            }
            
            document.getElementById('sendResetBtn').textContent = 'Sending...';
            
            try {
                const response = await fetch('/api/email-otp/forgot-password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email})
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('resetVerification').style.display = 'block';
                    document.getElementById('sendResetBtn').textContent = 'OTP Sent!';
                    showSuccess('Reset OTP Sent', data.message + (data.otp ? ` OTP: ${data.otp}` : ''));
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showError('Failed to send reset OTP', error.message);
                document.getElementById('sendResetBtn').textContent = 'Send Reset OTP';
            }
        }
        
        async function resetPassword() {
            const email = document.getElementById('resetEmail').value;
            const otp = document.getElementById('resetOTP').value;
            const newPassword = document.getElementById('newPassword').value;
            
            if (!otp || !newPassword) {
                showError('Error', 'Please enter OTP and new password');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('Error', 'Password must be at least 6 characters');
                return;
            }
            
            try {
                const response = await fetch('/api/email-otp/reset-password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, otp, newPassword})
                });
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Password Reset Successful', data.message);
                    setTimeout(() => {
                        showPasswordLogin();
                        document.getElementById('resetEmail').value = '';
                        document.getElementById('resetOTP').value = '';
                        document.getElementById('newPassword').value = '';
                    }, 2000);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showError('Password Reset Failed', error.message);
            }
        }
    </script>
</body>
</html>